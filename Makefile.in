######################################################### -*-Makefile-*-
#
# File:   Makefile
# Author: Alex Samuel
# Date:   2000-12-20
#
# Contents:
#   Top-level qm makefile.
# 
# Copyright (C) 2001 CodeSourcery LLC
#
# Permission is hereby granted, free of charge, to any person
# obtaining a copy of this software and associated documentation files
# (the "Software"), to deal in the Software without restriction,
# including without limitation the rights to use, copy, modify, merge,
# publish, distribute, sublicense, and/or sell copies of the Software,
# and to permit persons to whom the Software is furnished to do so,
# subject to the following conditions:
#
# The above copyright notice and this permission notice shall be
# included in all copies or substantial portions of the Software.
#
# THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
# EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
# MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
# NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS
# BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN
# ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN
# CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
# SOFTWARE.
#
########################################################################

TOPDIR		= @top_srcdir@

SUBDIRS		= doc

PYTHONDOCDIRS	= qm

# Python packages with installation scripts.
PYTHON_PACKAGES = \
	qm \
	PyXML \
	sgmlop \
	zope-dtml/DocumentTemplate \
	zope-dtml/ExtensionClass \
	xmlrpc
# The names of rules to install the PYTHON_PACKAGES.
PYTHON_PACKAGES_INSTALL = $(PYTHON_PACKAGES:=-install)

# The scripts that are run to start QM.
SCRIPTS = qm/test/qmtest$(SCRIPT_EXT) \
	  qm/test/qmtest-remote$(SCRIPT_EXT)

include $(TOPDIR)/standard.mk

########################################################################
# additional rules
########################################################################

all:: $(PYTHON_PACKAGES) $(SCRIPTS)

# Build the Python packages.
.PHONY: $(PYTHON_PACKAGES)

$(PYTHON_PACKAGES):
	cd $@ && $(PYTHON) ./setup.py build

# Generate executable scripts.
ifneq ($(PYTHON_PLATFORM),win32)
$(SCRIPTS): qm/qm.sh
	rm -rf $@
	cp qm/qm.sh $@
	chmod a-w $@
	chmod a+x $@
else
PYTHONEXE = `@PYTHON@ -c "import sys; print sys.prefix"`\\python
$(SCRIPTS): 
	rm -rf $@
	echo -e "@echo off\r" > $@
	echo -e "set QM_HOME=$(prefix)\r" >> $@
	echo -e "set QM_BUILD=0\r" >> $@
	echo -n "$(PYTHONEXE) \"%QM_HOME%\\lib\\qm\\qm\\$@.py\r" " >> $@
	echo -e "%1 %2 %3 %4 %5 %6 %7 %8 %9\r" >> $@
endif

clean::
	for x in $(PYTHON_PACKAGES); do \
		pushd $$x; $(PYTHON) ./setup.py clean; popd; \
	done

# Run tests.
check: all
	qm/test/qmtest -D tests run $(QMTESTFLAGS)

########################################################################
# installation
########################################################################

# Install everything.
install: \
	$(PYTHON_PACKAGES_INSTALL) \
	doc-install \
	scripts-install \
	share-install
	$(INSTALL_DATA) -D qm/test/classes/classes.qmc \
		"$(INSTALLLIBDIR)/qm/test/classes/classes.qmc"

# Install Python packages that use distutils.
.PHONY: $(PYTHON_PACKAGES_INSTALL)

# Unfortunately, some versions of Python's Distutils do not set modes
# on the installed files so we have to do it manually here.  There is
# no easy way to get the permissions set correctly on the directories
# created; the directories are not output by Distutils.
$(PYTHON_PACKAGES_INSTALL):
	cd $(@:-install=) && \
		MANIFEST=$(notdir $(@:-install=))-manifest && \
		$(PYTHON) ./setup.py install -O1 \
	        --prefix="$(prefix)" \
		--install-purelib="$(INSTALLLIBDIR)" \
                --install-platlib="$(INSTALLLIBDIR)" \
                --install-scripts="$(INSTALLSHAREDIR)" \
		--install-data="$(INSTALLSHAREDIR)" \
		--record=$$MANIFEST && \
		for x in `cat $$MANIFEST`; do \
			test -x $$x && chmod 0755 $$x || \
				chmod 0644 $$x; \
		done && \
		rm $$MANIFEST

# Install documentation.
.PHONY: doc-install

doc-install:
	$(INSTALL_DIR) "$(INSTALLDOCDIR)"
	$(INSTALL_DATA) README COPYING "$(INSTALLDOCDIR)"
	$(INSTALL_DIR) "$(INSTALLDOCDIR)/manual/html"
	$(INSTALL_DATA) doc/manual/html/*.html "$(INSTALLDOCDIR)/manual/html"
	$(INSTALL_DIR) "$(INSTALLDOCDIR)/manual/print"
	$(INSTALL_DATA) doc/manual/print/manual.pdf \
		"$(INSTALLDOCDIR)/manual/print"

# Install scripts.
.PHONY: scripts-install

scripts-install:
	$(INSTALL_DIR) "$(INSTALLBINDIR)"
	$(INSTALL_SCRIPT) $(SCRIPTS) "$(INSTALLBINDIR)"

# Install the share directory by recursively copying its contents.
.PHONY: share-install

share-install:
	cd share && \
		find . \( -name '*.txt' -o -name '*.dtml' \
			  -o -name '*.qmt' -o -name 'configuration' \
			  -o -name '*.css' -o -name '*.js' \
			  -o -name '*.gif' -o -name 'CATALOG' \
			  -o -name '*.dtd' -o -name '*.mod' \) \
		-exec $(INSTALL_DATA) -D {} "$(INSTALLSHAREDIR)/{}" \;
